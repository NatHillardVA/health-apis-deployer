# Deployment Unit





### Product Repository Structure
```
<product>/
├── Jenkinsfile
├── pom.xml
├── deployment.yaml
├── deployment.conf
├── qa.conf
├── qa.testvars
├── staging-lab.conf
├── staging-lab.testvars
├── lab.conf
├── lab.testvars
├── staging.conf
├── staging.testvars
├── production.conf
├── production.testvars
└── test.conf
```

`Jenkinsfile`  
Responsible for building DU container and deploying it to Nexus as a project assembly.

`deployment.yaml`  
Contains all k8s resources except ingress objects related to this deployment unit. All items must
be contained with the DU's namespace.

`deployment.conf`
Configuration variables that will be applied in all environments, such as application versions.

`qa.conf`, `staging.conf`, `production.conf`, `staging-lab.conf`, `lab.conf`  
Configuration files for specific environments.

`qa.testvars`, `staging.testvars`, `production.testvars`, `staging-lab.testvars`, `lab.testvars`  
Environment variable files for specific environments used when running tests.  
**WARNING**: Docker env files are literal and do not use shell evaluation. Quoutes, dollar signs, 
new lines, etc. will be passed literally to your application.

`test.conf`  
Test container configuration for regression and smoke tests. File contents must set `TEST_IMAGE` 
to Docker image to run for tests, e.g.
```
export TEST_IMAGE=chillo/armadillo:1.2.3
```



> ##### Conf files
> `.conf` files are bits of bash code that are evaluated during the deployment process. `.conf`
files may contain bits of logic, functions, etc. to compute values that will be used. However, to
enable substitution in the `deployment.yaml` variables must be exported, e.g. 
> ``` 
> export CHILLO=ARMADILLO`   # $CHILLO is available for substitution
> WIGGLY=PIGGLY              # $WIGGLY is not available
> ```

> ##### Testvars files
> `.testvars` contain variables needed for tests in in Docker `--env-file` format and will be
> used to set environment variables during test execution. Format is `var=value`, one per line, e.g.
> ```
> CHILLO=ARMADILLO
> WIGGLY=PIGGLY
> ```

> ##### Deployment YAML substitution
> The `deployment.yaml` will be processed using `envsubst` to provide environment specific 
values to be injected into the yaml. The environment variables from `deployment.conf` and the
environment specific conf, e.g. `qa.conf` will be set. Additional, the following variables will be
also be set.
>  
> `NAMESPACE`  
The kubernetes namespace the deployment unit must use.
>
>`K8S_ENVIRONMENT`  
The Kubernetes environment name, e.g. `qa`, `staging`, `production`, `staging-lab` or `lab`
>
> `K8S_DEPLOYMENT_ID`  
> A unique string ID generated by the Jenkins orchestation pipeline for this particular deployment.
> 
> `K8S_LOAD_BALANCER`  
> The host name of the load balancer where your deployment will be made available. 



> ##### Protecting Sensitive Information
> `.conf`  and `.testvars` files may need to contain sensitive information such as access tokens 
or passwords. Conf files may be stored as an encrypted zip files with `.conf.zip` extension. 
Likewise, Testvar files may be stored as an encrypted zip files with `.testvars.zip` extension.
Decryption key must be stored in as a Jenkins credential to be used to execute the DU docker image.
Coordinate with the DevOps team if you need encryption.


---

### Blue/Green Deployment Process
 
The `health-apis-deployment-unit` docker image provides machinery necessary to deploy products into
the k8s cluster. Deployments are orchestrated at a higher level by Jenkins which kick off 
deployment, trigger rollback if necessary, and handle reporting.

For a given environment
- Perform sanity check against `deployment.yaml`
- Load `deployment.conf`
- Load `${environment}.conf`
- Perform `envsubst` style substitution on the `deployment.yaml` to produce a final configuration

For each Availability Zone supported by the cluster in this environment
- Detach the deployment unit's AZ-specific target group from the k8s blue load balancer
- Save ingress rules from the DU namespace
- Delete the DU namespace
- Create the namespace
- Restore ingress rules
- Apply substituted final configuration
- Attach DU AZ-specific target group to the k8s green load balancer
- Load `test.conf`
- Run regression test container (stdout will be captured and made available on Jenkins)

On regression test success
- Attach the deployment unit's AZ-specific target group to the k8s blue load balancer
- Begin next AZ

On regression test failure in QA
- Environment is left in current state and is available for debugging which may be a mixture of 
  partially upgraded AZs  
- Deployment to next AZ is skipped 

On regression test failure in upper environments
- Logs are captured from all pods in the failed AZ and provided on Jenkins
- Previously installed version is re-applied to this and any previously updated AZs by re-running
  previously installed versions docker image
- Blue load balancer is restored


> The above steps are achieved by a combination of the deployment unit docker image, the routes
docker image, and the Jenkins pipeline that orchestrates the pipeline.


---
### Testing Deployment Units
The Orchestrating Jenkins pipeline may choose to perform regression or smoke tests based on
various situations.

##### Regression tests
- Ran during product version install
- May be long running

##### Smoke tests
- Ran during route changes to verify connectivity to DU through load balancers and k8s ingress
- Should execute quickly
- Should exercise operations that cover each expect HTTP path  
  For example, if the DU expects paths `/awesome/possum` and `/chillo/armadillo` to be available,
  then a smoke test might simply contain two reads and a health check.

##### Test container contract
- Test container will accept one test type argument: `regression-test` or `smoke-test`
- Test container will be provided the environment variables as listed below
- Test container shall provide an exit code of `0` to indicate success and any non-zero value
  to indicate failure
- Standard out will be captured and provided on Jenkins

The following environment variables will be provided to the test container in both regression and
smoke test modes. (Description above).
- `K8S_ENVIRONMENT`
- `K8S_DEPLOYMENT_ID`
- `K8S_LOAD_BALANCER`

Additionally, any values in `${environment}.testvars` will be passed to your container.

Example
```
docker run \
  --rm \
  --network host \
  --env-file qa.testvars \
  --env K8S_ENVIRONMENT=qa \
  --env K8S_DEPLOYMENT_ID=ABC123 \
  --env K8S_LOAD_BALANCER=green.qa.ligthouse.va.gov \
  vasdvp/health-apis-data-query-test \
  regression-test
```





