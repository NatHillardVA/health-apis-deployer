#!/usr/bin/env bash
set -euo pipefail

TEST=$1
AVAILABILITY_ZONE=$2
DU_DIR=$3
LOG_DIR=$4
test -n "$DU_DIR"
test -d "$LOG_DIR"
test -f "$DU_DIR/test.conf"

. $DU_DIR/test.conf

echo "Running $TEST on $TEST_IMAGE"

docker run \
  --rm \
  --network host \
  --env-file $DU_DIR/$ENVIRONMENT.testvars \
  --env K8S_ENVIRONMENT=$ENVIRONMENT \
  --env K8S_DEPLOYMENT_ID=$K8S_DEPLOYMENT_ID \
  --env K8S_LOAD_BALANCER=$GREEN_LOAD_BALANCER \
  --env EXIT_STATUS=1 \
  $TEST_IMAGE \
  $TEST \
  | tee $LOG_DIR/$TEST-$AVAILABILITY_ZONE.log
