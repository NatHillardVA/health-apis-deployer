#!/usr/bin/env bash
set -euo pipefail

DU_DIR=$1

test -n "$DU_DIR"
test -n "$ENVIRONMENT"

DEFAULT_CONF=$DU_DIR/deployment.conf
ENV_CONF=$DU_DIR/$ENVIRONMENT.conf

test -f "$DEFAULT_CONF"
test -f "$ENV_CONF"

declare -rx NAMESPACE=$DU_NAMESPACE

echo "Standardizing Line Endings..."
dos2unix -q $(find $DU_DIR -name "*.yaml" -or -name "*.properties" -or -name "*.conf" -or -name "*.testvars" -or -name "*.yml")

. $DEFAULT_CONF
. $ENV_CONF

for i in $(find $DU_DIR -name "*.yaml" -or -name "*.properties" -or -name "*.yml")
do
  echo "Substituting values in ${i/$DU_DIR/}"
  FILE_PATH=$i
  FILE_BACKUP="$i.original"
  mv $FILE_PATH $FILE_BACKUP
  cat $FILE_BACKUP | envsubst > $FILE_PATH
  rm $FILE_BACKUP
done
