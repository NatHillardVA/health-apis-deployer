#!/usr/bin/env bash

set -euo pipefail

#
# Helper script for blue-green deployment strategy
# This script will attach a product to a loadbalancer by...
# 1. Creating a target group, for the product, if one doesn't exist
# 2. Attaching the new/existing product target group to a singular
#    AZ's auto-scaling group
# 3. Creating a Load Balancer rule that routes traffic along a
#    given product's path, respecting priority
#

#
# Color of the load-balancer
# Blue - production/public traffic
# Green -testing/internal use
#
COLOR=$1

test -n "$COLOR"

[ "${LEAVE_ON_GREEN:-false}" == true ] \
  && [ "$COLOR" == "blue" ] \
  && exit 0

#
# The prefix we use for AZ's is the last character of the string...
# Example: us-gov-west-1a
#                       ^
#
AZ_ABREVIATION=${AVAILABILITY_ZONE: -1}

#
# Work around export arrays limitation
#
. $LOAD_BALANCER_RULES

test -n "$CLUSTER_ID"
test -n "$DU_HEALTH_CHECK_PATH"
test -n "${#DU_LOAD_BALANCER_RULES[@]}"
test -n "$AZ_ABREVIATION"
test -n "$VPC_NAME"

echo "============================================================"
echo "Attaching $PRODUCT to $CLUSTER_ID $COLOR load balancer"

load-balancer create-target-group \
    --env "$VPC_NAME" \
    --cluster-id "$CLUSTER_ID" \
    --color "$COLOR" \
    --product "$PRODUCT" \
    --health-check-path="$DU_HEALTH_CHECK_PATH" \

if [ $? != 0 ]; then echo "TARGET GROUP CREATION FAILED!!! $PRODUCT on $CLUSTER_ID $COLOR load balancer is potentially unstable!" && exit 1; fi


load-balancer enable-target-group \
    --env "$VPC_NAME" \
    --cluster-id "$CLUSTER_ID" \
    --color "$COLOR" \
    --product "$PRODUCT" \
    --az-abreviation="$AZ_ABREVIATION"

if [ $? != 0 ]; then echo "ENABLE TARGET GROUP FAILED!!! $PRODUCT on $CLUSTER_ID $COLOR load balancer is potentially unstable!" && exit 1; fi


for priority in ${!DU_LOAD_BALANCER_RULES[@]}
do
  rule="${DU_LOAD_BALANCER_RULES[$priority]}"
  echo "Creating rule $rule with minimum priority $priority"
  load-balancer create-rule \
    --env "$VPC_NAME" \
    --cluster-id "$CLUSTER_ID" \
    --color "$COLOR" \
    --product "$PRODUCT" \
    --rule-path "$rule" \
    --min-priority "$priority" \
    --az-abreviation "$AZ_ABREVIATION"

  if [ $? != 0 ]; then echo "PRIORITY RULE CREATION FAILED!!! $PRODUCT on $CLUSTER_ID $COLOR is potentially unstable!" && exit 1; fi

done
