#!/usr/bin/env bash

#
# Wait for the load-balancer to leave it's initialization period for the new rule
# before launching tests against it
#

COLOR=$1

#
# Work around export arrays limitation
#
. $LOAD_BALANCER_RULES


test -n "${#DU_LOAD_BALANCER_RULES[@]}"
test -n "$COLOR"
test -n "$CLUSTER_ID"
test -n "$VPC_NAME"

echo "Waiting for load balancer to be ready."

checkAllRules() {
  for rule in "${DU_LOAD_BALANCER_RULES[@]}"
  do
    load-balancer rule-health --env $VPC_NAME --cluster-id $CLUSTER_ID --color $COLOR --rule-path "$rule"
    [ $? != 0 ] && return 1
  done
  return 0
}


timeout=$(($(date +%s) + 300))
while [ $(date +%s) -lt $timeout ]
do
  sleep 1
  checkAllRules
  [ $? != 0 ] && continue
  echo "sleeping 60"
  sleep 30
  exit 0
done

echo "$PRODUCT timed out waiting for ($COLOR) load balancer to become healthy" >> $JENKINS_DESCRIPTION
echo "Timeout waiting for load balancer to become healthy"
exit 1
